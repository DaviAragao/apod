<script>
class LazyImg
{
	constructor(elementsToObserve, imgType = 1) {
		this.imgType = imgType;
		('IntersectionObserver' in window) ? this.observeElements(elementsToObserve) : this._loadAllImages(elementsToObserve);
	}

	observeElements (elementsToObserve) {
		const config = {
			rootMargin: '50px 0px',
			threshold: 0.01
		};

		this._onIntersection = this._onIntersection.bind(this);
		let observer = new IntersectionObserver(this._onIntersection, config);
		for (const element of elementsToObserve)
			observer.observe(element);
	}

	_onIntersection (entries, observer) {
		for (const entry of entries) {
			if (entry.intersectionRatio > 0) {
				observer.unobserve(entry.target);
				this._fetchImage(entry.target).then(() => this.loadImage(entry.target));
			}
		}
	}

	_loadAllImages (elementsToObserve) {
		for (const element of elementsToObserve)
			this.loadImage(element);

	}

	_fetchImage (element) {
		return new Promise((resolve, reject) => {
			const img = new Image();
			img.src = element.dataset.img;
			img.onload = resolve;
			img.onerror = reject;
		});
	}

	loadImage (element) {
		(this.imgType) ? element.style.backgroundImage = `url(${element.dataset.img})` : element.src = element.dataset.img;
	}
}
</script>
